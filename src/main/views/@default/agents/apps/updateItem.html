{$layout}
{$template "/code_editor"}
{$template "menu"}

<div class="ui text menu small blue">
    <a :href="'/agents/apps/itemDetail?agentId=' + agentId + '&appId=' + app.id + '&itemId=' + item.id + '&from=' + from" class="item active">{{item.name}} &raquo; 详情</a>
    <span class="item">|</span>
    <a :href="'/agents/apps/itemValues?agentId=' + agentId + '&appId=' + app.id + '&itemId=' + item.id + '&from=' + from" class="item">数值记录</a>
    <span class="item">|</span>
    <a :href="'/agents/apps/itemCharts?agentId=' + agentId + '&appId=' + app.id + '&itemId=' + item.id" class="item">图表<span>({{item.charts.length}})</span></a>
</div>
<div class="ui divider"></div>

<form class="ui form" data-tea-action="$" data-tea-success="submitSuccess">
    <input type="hidden" name="agentId" :value="agentId"/>
    <input type="hidden" name="appId" :value="app.id"/>
    <input type="hidden" name="itemId" :value="item.id"/>
    <table class="ui table definition">
        <tr>
            <td class="title">监控项名称 *</td>
            <td>
                <input type="text" name="name" v-model="item.name" maxlength="100"/>
                <p class="comment">比如连接数监控</p>
            </td>
        </tr>
        <tr>
            <td>数据源 *</td>
            <td>
                <select class="ui dropdown" name="sourceCode" v-model="sourceCode" @change="changeSource()" style="width:10em">
                    <option v-for="source in sources" :value="source.code">{{source.name}}</option>
                </select>
                <p class="comment">{{sourceDescription}}</p>
            </td>
        </tr>

        <!-- 脚本 -->
        <tbody v-show="sourceCode == 'script'">
            <tr>
                <td>脚本 *</td>
                <td>
					<input type="hidden" name="scriptType" :value="scriptTab"/>
					<input type="hidden" name="scriptLang" :value="scriptLang"/>
					<div class="ui tabular menu attached small">
						<a class="item" :class="{active:scriptTab == 'path'}" @click.prevent="selectScriptTab('path')">脚本文件</a>
						<a class="item" :class="{active:scriptTab == 'code'}" @click.prevent="selectScriptTab('code')" v-if="!teaDemoEnabled">脚本代码</a>
					</div>
					<div class="ui bottom segment attached" v-show="scriptTab == 'path'">
						<input type="text" name="scriptPath" maxlength="100" v-model="item.sourceOptions.path"/>
						<p class="comment">如果是Shell脚本，请不要忘记在头部添加 <em>#!脚本解释工具</em>，比如 <em>#!/bin/bash</em></p>
					</div>
					<div class="ui bottom segment attached" v-show="scriptTab == 'code'" style="padding-top:0">
						<div class="ui menu text small">
							<a class="item" v-for="lang in scriptLangs" :class="{active:lang.code == scriptLang}" @click.prevent="selectScriptLang(lang.code)">{{lang.name}}</a>
						</div>
						<textarea name="scriptCode" id="script-code-editor" rows="1"></textarea>
						<p class="comment">如果是Shell脚本，请不要忘记在头部添加 <em>#!脚本解释工具</em>，比如 <em>#!/bin/bash</em></p>
					</div>
                </td>
            </tr>
            <tr v-show="advancedOptionsVisible">
                <td>当前工作目录<em>（CWD）</em></td>
                <td>
                    <input type="text" name="scriptCwd" v-model="item.sourceOptions.cwd" maxlength="100"/>
                </td>
            </tr>
            <tr v-show="advancedOptionsVisible">
                <td>环境变量<em>（ENV）</em></td>
                <td>
                    <div class="ui field">
                        <span class="ui label small" v-for="(var1, index) in env">
                            <input type="hidden" name="scriptEnvNames" :value="var1.name"/>
                            <input type="hidden" name="scriptEnvValues" :value="var1.value"/>
                            <em>{{var1.name}}</em>: {{var1.value}}
                            <a href="" @click.prevent="removeEnv(index)"><i class="icon remove"></i></a>
                        </span>
                    </div>
                    <div v-if="envAdding" class="ui fields inline">
                        <div class="ui field">
                            <input type="text" name="envAddingName" v-model="envAddingName" placeholder="变量名" style="width:9em" @keyup.enter="confirmAddEnv" @keypress.enter.prevent="1"/>
                        </div>
                        <div class="ui field">
                            <input type="text" name="envAddingValue" v-model="envAddingValue" placeholder="变量值" style="width:15em" @keyup.enter="confirmAddEnv" @keypress.enter.prevent="1"/>
                        </div>
                        <div class="ui field">
                            <button class="ui button" type="button" @click="confirmAddEnv()">添加</button>
                        </div>
                        <div class="ui field">
                            <a href="" @click.prevent="cancelEnv()"><i class="icon remove"></i></a>
                        </div>
                    </div>
                    <div class="ui field">
                        <button class="ui button small" type="button" @click="addEnv()">+</button>
                    </div>
                </td>
            </tr>
        </tbody>

        <!-- WebHook -->
        <tbody v-show="sourceCode == 'webhook'">
            <tr>
                <td>URL *</td>
                <td>
                    <input type="text" name="webhookURL" maxlength="100" v-model="item.sourceOptions.url" placeholder="http://..."/>
                </td>
            </tr>
            <tr>
                <td>请求方法 *</td>
                <td>
                    <select name="webhookMethod" class="ui dropdown" v-model="item.sourceOptions.method" style="width:10em">
                        <option v-for="method in methods" :value="method">{{method}}</option>
                    </select>
                </td>
            </tr>
            <tr v-show="advancedOptionsVisible">
                <td>请求超时<em>（Timeout）</em></td>
                <td>
                    <div class="ui input right labeled">
                        <input type="text" name="webhookTimeout" v-model="item.sourceOptions.timeout" style="width: 5em" maxlength="10" value="10"/>
                        <label class="ui label">秒</label>
                    </div>
                </td>
            </tr>
        </tbody>

        <!-- 文件 -->
        <tbody v-show="sourceCode == 'file'">
            <tr>
                <td>数据文件路径 *</td>
                <td>
                    <input type="text" name="filePath" v-model="item.sourceOptions.path" maxlength="100"/>
                </td>
            </tr>
        </tbody>
        <tr>
            <td colspan="2">
                <a href="" v-if="!advancedOptionsVisible" @click.prevent="showAdvancedOptions()" style="font-weight:normal">更多选项 <i class="icon down angle"></i> </a>
                <a href="" v-if="advancedOptionsVisible" @click.prevent="showAdvancedOptions()" style="font-weight:normal">收起选项 <i class="icon up angle"></i> </a>
            </td>
        </tr>
        <tbody v-show="advancedOptionsVisible">
            <tr>
                <td>数据格式</td>
                <td>
                    <select class="ui dropdown" name="dataFormat" v-model="item.sourceOptions.dataFormat" style="width:10em" @change="changeDataFormat()">
                        <option v-for="dataFormat in dataFormats" :value="dataFormat.code">{{dataFormat.name}}</option>
                    </select>
					<p class="comment">{{dataFormatDescription}}</p>
                </td>
            </tr>
            <tr>
                <td>刷新间隔</td>
                <td>
                    <div class="ui input right labeled">
                        <input type="text" name="interval" v-model="item.interval" style="width: 5em" maxlength="10" value="30"/>
                        <label class="ui label">秒</label>
                    </div>
                </td>
            </tr>
            <tr>
                <td>阈值设置<em>（触发条件）</em></td>
                <td>
					<p class="threshold-box">
						<span class="ui label small" v-for="(cond, index) in conds" :class="{blue:addingCond != null && cond.id == addingCond.id}">{{cond.param}} <em>{{cond.op}}</em> {{cond.value}} [<var>{{cond.noticeLevelName}}</var><var v-if="cond.noticeMessage != null && cond.noticeMessage.length > 0">:{{cond.noticeMessage}}</var>] <var v-if="cond.actions.length > 0">[{{cond.actions.length}}动作]</var>&nbsp; <a href="" title="修改" @click.prevent="editCond(cond)"><i class="icon pencil small"></i></a> <a href="" title="删除" @click.prevent="removeCond(index)"><i class="icon remove small"></i></a>
						<input type="hidden" name="condParams" v-model="cond.param"/>
						<input type="hidden" name="condOps" v-model="cond.op"/>
						<input type="hidden" name="condValues" v-model="cond.value"/>
						<input type="hidden" name="condNoticeLevels" v-model="cond.noticeLevel"/>
						<input type="hidden" name="condNoticeMessages" v-model="cond.noticeMessage"/>
						<input type="hidden" name="condActions" :value="JSON.stringify(cond.actions)"/>
						</span>

					</p>
					<div v-if="addingCond != null" class="field">
						<table class="ui table without-definition">
							<thead>
							<tr>
								<th>参数</th>
								<th>运算符</th>
								<th>对比阈值</th>
							</tr>
							</thead>
							<tbody>
							<tr>
								<td>
									<input type="text" name="addingParam" v-model="addingCond.param"/>
								</td>
								<td style="width:11em">
									<select class="ui dropdown" style="width:10em" v-model="addingCond.op" @change="changeCondOp(addingCond)">
										<option v-for="op in operators" :value="op.op">{{op.name}}</option>
									</select>
									<p class="comment">{{addingCond.description}}</p>
								</td>
								<td class="value-td">
									<input type="text" v-model="addingCond.value"/>
								</td>
							</tr>
							<tr>
								<td>
									<select class="ui dropdown" style="width:10em" v-model="addingCond.noticeLevel">
										<option v-for="level in noticeLevels" :value="level.code">{{level.name}}</option>
									</select>
								</td>
								<td colspan="2">
									<input type="text" v-model="addingCond.noticeMessage" placeholder="通知消息，可以为空"/>
								</td>
							</tr>
							<tr v-for="(actionMap, index) in addingCond.actions">
								<td>
									<select class="ui dropdown" style="width:10em" name="actionCodes" v-model="actionMap.code">
										<option v-for="action in actions" :value="action.code">{{action.name}}</option>
									</select>
								</td>
								<td colspan="2">
									<input type="text" v-model="actionMap.options.path" placeholder="脚本路径"/>
									<p class="comment"><a href="" title="删除此动作" @click.prevent="removeCondAction(index)"><i class="icon remove small"></i> </a> </p>
								</td>
							</tr>
							<tr>
								<td colspan="3"><a href="" style="font-weight: normal;" @click.prevent="addCondAction()">+动作 &nbsp; <span style="color: rgba(0, 0, 0, 0.3)">(需要将Agent更新到v0.0.9版本以上)</span></a></td>
							</tr>
							</tbody>
						</table>
						<button class="ui primary button small" type="button" @click.prevent="confirmAddingCond()" v-if="addingCond.isAdding">确认添加</button>
						<button class="ui primary button small" type="button" @click.prevent="saveCond()" v-if="!addingCond.isAdding">保存修改</button> &nbsp; <a href="" @click.prevent="cancelAddingCond()">取消</a>
					</div>

					<button type="button" class="ui button small" @click="addCond()" v-if="addingCond == null">+</button>

					<p class="comment">使用<span class="ui label tiny">${N}</span>表示第N行数据，从0行开始，比如：<span class="ui label tiny">${0}</span>, <span class="ui label tiny">${1}</span>；使用<span class="ui label tiny">${NAME}</span>来获取KEY-VALUE形式的数据，比如<span class="ui label tiny">${name}</span>。支持加(+)减(-)乘(*)除(/)取余(%)运算符。</p>
                </td>
            </tr>
            <tr>
                <td>是否启用</td>
                <td>
                    <div class="ui checkbox">
                        <input type="checkbox" name="on" value="1" v-model="item.on"/>
                        <label></label>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <button class="ui button primary" type="submit">保存</button> &nbsp; <a :href="from">返回</a>
</form>